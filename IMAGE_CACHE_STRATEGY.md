# å›¾ç‰‡ç¼“å­˜ç­–ç•¥ - æˆæœ¬ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

**æœ€å°åŒ– Image Resizing API è°ƒç”¨æ¬¡æ•°ï¼Œå……åˆ†åˆ©ç”¨å…è´¹çš„ R2 å’Œ CDN ç¼“å­˜**

## ğŸ“Š ä¸‰çº§ç¼“å­˜æ¶æ„

```
ç”¨æˆ·è¯·æ±‚
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ä¸€çº§ï¼šCDN è¾¹ç¼˜ç¼“å­˜ï¼ˆCloudflare CDNï¼‰           â”‚
â”‚ â€¢ å‘½ä¸­ç‡ç›®æ ‡ï¼š> 95%                             â”‚
â”‚ â€¢ å“åº”æ—¶é—´ï¼š< 10ms                              â”‚
â”‚ â€¢ è´¹ç”¨ï¼šå…è´¹                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“ æœªå‘½ä¸­
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬äºŒçº§ï¼šR2 ç¼“å­˜ï¼ˆå­˜å‚¨è½¬æ¢ç»“æœï¼‰                  â”‚
â”‚ â€¢ å‘½ä¸­ç‡ç›®æ ‡ï¼š> 90%                             â”‚
â”‚ â€¢ å“åº”æ—¶é—´ï¼š50-100ms                            â”‚
â”‚ â€¢ è´¹ç”¨ï¼š$0.015/GB/æœˆï¼ˆå­˜å‚¨ï¼‰                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“ æœªå‘½ä¸­
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ä¸‰çº§ï¼šåŠ¨æ€è½¬æ¢ï¼ˆImage Resizing APIï¼‰          â”‚
â”‚ â€¢ ä»…é¦–æ¬¡è¯·æ±‚                                    â”‚
â”‚ â€¢ å“åº”æ—¶é—´ï¼š200-500ms                           â”‚
â”‚ â€¢ è´¹ç”¨ï¼š$1-5/1000æ¬¡ è½¬æ¢                        â”‚
â”‚ â€¢ è½¬æ¢åç«‹å³ç¼“å­˜åˆ° R2                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ å®Œæ•´è¯·æ±‚æµç¨‹

### åœºæ™¯ 1ï¼šé¦–æ¬¡è¯·æ±‚ï¼ˆå†·å¯åŠ¨ï¼‰

```
1. ç”¨æˆ·è¯·æ±‚: /r2/images/photo-original.jpg?format=webp&width=800
   â†“
2. CDN æ£€æŸ¥ï¼šæœªå‘½ä¸­ï¼ˆé¦–æ¬¡è¯·æ±‚ï¼‰
   â†“
3. Worker å¤„ç†ï¼š
   a. æ£€æŸ¥ R2 ç¼“å­˜: cache/images/photo-original-fwebp-w800.webp
   b. æœªæ‰¾åˆ°ï¼Œéœ€è¦è½¬æ¢
   c. è°ƒç”¨ Image Resizing APIï¼ˆğŸ’° äº§ç”Ÿè´¹ç”¨ï¼‰
   d. è½¬æ¢æˆåŠŸï¼Œè·å¾— WebP æ•°æ®
   e. å¼‚æ­¥å­˜å‚¨åˆ° R2 ç¼“å­˜ï¼ˆä¸é˜»å¡å“åº”ï¼‰
   f. ç«‹å³è¿”å›ç»™ç”¨æˆ·
   â†“
4. CDN ç¼“å­˜è½¬æ¢ç»“æœï¼ˆè‡ªåŠ¨ï¼ŒåŸºäº Cache-Control å¤´ï¼‰
   â†“
5. R2 åå°å­˜å‚¨å®Œæˆ
```

**è´¹ç”¨ï¼š** 1 æ¬¡ Image Resizing API è°ƒç”¨ï¼ˆçº¦ $0.001-0.005ï¼‰

### åœºæ™¯ 2ï¼šç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆCDN å‘½ä¸­ï¼‰

```
1. ç”¨æˆ·è¯·æ±‚: /r2/images/photo-original.jpg?format=webp&width=800
   â†“
2. CDN æ£€æŸ¥ï¼šâœ… å‘½ä¸­ï¼
   â†“
3. ç›´æ¥è¿”å›ç¼“å­˜ï¼ˆä¸åˆ°è¾¾ Workerï¼‰
```

**è´¹ç”¨ï¼š** å…è´¹ï¼

### åœºæ™¯ 3ï¼šCDN ç¼“å­˜è¿‡æœŸï¼ŒR2 ç¼“å­˜å‘½ä¸­

```
1. ç”¨æˆ·è¯·æ±‚: /r2/images/photo-original.jpg?format=webp&width=800
   â†“
2. CDN æ£€æŸ¥ï¼šæœªå‘½ä¸­ï¼ˆç¼“å­˜è¿‡æœŸæˆ–æ¸…é™¤ï¼‰
   â†“
3. Worker å¤„ç†ï¼š
   a. æ£€æŸ¥ R2 ç¼“å­˜: cache/images/photo-original-fwebp-w800.webp
   b. âœ… æ‰¾åˆ°ï¼ç›´æ¥è¯»å–
   c. è¿”å›ç»™ç”¨æˆ·ï¼ˆ50-100msï¼‰
   â†“
4. CDN é‡æ–°ç¼“å­˜
```

**è´¹ç”¨ï¼š** R2 è¯»å–ï¼ˆClass A æ“ä½œï¼Œæ¯æœˆåŒ…å« 1000ä¸‡æ¬¡å…è´¹ï¼‰

## ğŸ’° æˆæœ¬åˆ†æ

### ç¤ºä¾‹ï¼š1000 å¼ å›¾ç‰‡ï¼Œæ¯å¼  3 ç§å°ºå¯¸

| åœºæ™¯ | è¯·æ±‚æ•° | Image Resizing è°ƒç”¨ | R2 è¯»å– | CDN å‘½ä¸­ | æ€»è´¹ç”¨ |
|------|--------|---------------------|---------|----------|--------|
| **æ— ç¼“å­˜ï¼ˆæ¯æ¬¡è½¬æ¢ï¼‰** | 100ä¸‡æ¬¡ | 100ä¸‡æ¬¡ | 0 | 0 | **$1000-5000** ğŸ’¸ |
| **ä»… CDN ç¼“å­˜** | 100ä¸‡æ¬¡ | 3000æ¬¡ | 97000æ¬¡ | 99.7ä¸‡æ¬¡ | **$3-15** ğŸ’° |
| **ä¸‰çº§ç¼“å­˜ï¼ˆæœ¬æ–¹æ¡ˆï¼‰** | 100ä¸‡æ¬¡ | 3000æ¬¡ | 100æ¬¡ | 99.99ä¸‡æ¬¡ | **$3-15** âœ… |

### è´¹ç”¨å¯¹æ¯”

```
åœºæ™¯                        æ¯ç™¾ä¸‡è¯·æ±‚è´¹ç”¨
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ— ç¼“å­˜ï¼ˆæ¯æ¬¡è½¬æ¢ï¼‰         $1,000 - $5,000 ğŸ’¸
åªç”¨ CDN ç¼“å­˜              $3 - $15       ğŸ’°
ä¸‰çº§ç¼“å­˜ï¼ˆæ¨èï¼‰           $3 - $15       âœ…
```

**èŠ‚çœæˆæœ¬ï¼š** 99.7% - 99.9%

## ğŸ“‚ R2 ç¼“å­˜å­˜å‚¨ç»“æ„

```
R2 Bucket:
â”œâ”€â”€ images/                           ï¼ˆåŸå›¾å’Œé¢„å¤„ç†å›¾ï¼‰
â”‚   â”œâ”€â”€ 1234567890-abc-hash1-original.jpg
â”‚   â”œâ”€â”€ 1234567890-abc-hash1-display.webp
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ cache/images/                     ï¼ˆåŠ¨æ€è½¬æ¢ç¼“å­˜ï¼‰
    â”œâ”€â”€ 1234567890-abc-hash1-original-fwebp-w800.webp
    â”œâ”€â”€ 1234567890-abc-hash1-original-fwebp-w400.webp
    â”œâ”€â”€ 1234567890-abc-hash1-original-fwebp-w1200.webp
    â”œâ”€â”€ 1234567890-abc-hash1-original-fjpeg-w800-q90.jpg
    â””â”€â”€ ...
```

### ç¼“å­˜ Key å‘½åè§„åˆ™

```
cache/{åŸå§‹è·¯å¾„}-{å‚æ•°æ ‡è¯†}.{æ‰©å±•å}

å‚æ•°æ ‡è¯†æ ¼å¼ï¼š
- f{format}      æ ¼å¼ï¼ˆfwebp, fjpeg, fpng, favifï¼‰
- w{width}       å®½åº¦ï¼ˆw800, w1200ï¼‰
- h{height}      é«˜åº¦ï¼ˆh600ï¼‰
- fit{mode}      é€‚é…æ¨¡å¼ï¼ˆfitcover, fitcropï¼‰
- q{quality}     è´¨é‡ï¼ˆq90, q75ï¼‰

ç¤ºä¾‹ï¼š
cache/images/123-abc-original-fwebp-w800.webp
cache/images/123-abc-original-fwebp-w400-h300-fitcover.webp
cache/images/123-abc-original-fjpeg-w1200-q95.jpg
```

## ğŸ” ç¼“å­˜çŠ¶æ€æ£€æŸ¥

### å“åº”å¤´è¯´æ˜

| å“åº”å¤´ | å€¼ | è¯´æ˜ |
|--------|-----|------|
| `X-Content-Source` | `R2-Cached` | âœ… ä» R2 ç¼“å­˜è¯»å–ï¼ˆæœ€å¿«ï¼‰ |
| `X-Content-Source` | `R2-Transformed-Fresh` | ğŸ”„ åˆšè½¬æ¢å®Œæˆï¼ˆé¦–æ¬¡ï¼‰ |
| `X-Image-Resizing` | `cached` | ç¼“å­˜å‘½ä¸­ |
| `X-Image-Resizing` | `enabled` | åˆšè½¬æ¢å®Œæˆ |

### æµ‹è¯•ç¼“å­˜æ•ˆæœ

```bash
# ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼ˆå†·å¯åŠ¨ï¼‰
curl -I "https://imageaigo.cc/r2/images/test-original.jpg?format=webp&width=800"
# æœŸæœ›ï¼šX-Content-Source: R2-Transformed-Fresh
# æœŸæœ›ï¼šX-Image-Resizing: enabled

# ç­‰å¾… 1 ç§’ï¼ˆè®© R2 ç¼“å­˜å®Œæˆï¼‰

# ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆåº”è¯¥ä» R2 ç¼“å­˜è¯»å–ï¼‰
curl -I "https://imageaigo.cc/r2/images/test-original.jpg?format=webp&width=800"
# æœŸæœ›ï¼šX-Content-Source: R2-Cached
# æœŸæœ›ï¼šX-Image-Resizing: cached

# ç¬¬ä¸‰æ¬¡è¯·æ±‚ï¼ˆåº”è¯¥ä» CDN è¯»å–ï¼Œä¸åˆ°è¾¾ Workerï¼‰
curl -I "https://imageaigo.cc/r2/images/test-original.jpg?format=webp&width=800"
# æœŸæœ›ï¼šæå¿«å“åº”ï¼ˆ< 10msï¼‰
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ä½¿ç”¨é¢„å®šä¹‰å°ºå¯¸

**æ¨èï¼š**
```javascript
const SIZES = {
  thumbnail: 200,
  small: 400,
  medium: 800,
  large: 1200
};

// ä½¿ç”¨é¢„å®šä¹‰å°ºå¯¸
<img src="/r2/images/photo.jpg?format=webp&width=800">
```

**é¿å…ï¼š**
```javascript
// âŒ æ¯ä¸ªç”¨æˆ·ä¸åŒçš„å°ºå¯¸ï¼Œç¼“å­˜å‘½ä¸­ç‡ä½
<img src="/r2/images/photo.jpg?format=webp&width=847">
<img src="/r2/images/photo.jpg?format=webp&width=832">
```

### 2. é¢„å¤„ç†å¸¸ç”¨å°ºå¯¸

å¯¹äºé‡è¦å›¾ç‰‡ï¼Œåœ¨ä¸Šä¼ æ—¶é¢„ç”Ÿæˆå¸¸ç”¨å°ºå¯¸ï¼š

```javascript
// ä¸Šä¼ æ—¶ç”Ÿæˆ
const sizes = [400, 800, 1200];
for (const size of sizes) {
  await generateAndCache(imageKey, { format: 'webp', width: size });
}
```

### 3. ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡

```bash
# æŸ¥çœ‹æ—¥å¿—ï¼Œç»Ÿè®¡ç¼“å­˜å‘½ä¸­ç‡
wrangler tail | grep ImageTransform

# ç›®æ ‡ï¼š
# - "Cache HIT" åº”è¯¥å  > 90%
# - "Cache MISS" åº”è¯¥åªåœ¨é¦–æ¬¡è¯·æ±‚å‡ºç°
```

## ğŸ§¹ ç¼“å­˜ç®¡ç†

### æŸ¥çœ‹ç¼“å­˜ä½¿ç”¨é‡

```bash
# æŸ¥çœ‹ R2 å­˜å‚¨ä½¿ç”¨
wrangler r2 object list imageaigo --prefix cache/

# ç»Ÿè®¡ç¼“å­˜æ–‡ä»¶æ•°é‡
wrangler r2 object list imageaigo --prefix cache/ | wc -l
```

### æ¸…ç†ç¼“å­˜ï¼ˆå¦‚éœ€è¦ï¼‰

```javascript
// æ¸…ç†ç‰¹å®šå›¾ç‰‡çš„æ‰€æœ‰ç¼“å­˜
async function clearImageCache(imageKey) {
  const prefix = `cache/${imageKey.replace(/\.[^.]+$/, '')}`;
  const list = await env.R2.list({ prefix });
  
  for (const object of list.objects) {
    await env.R2.delete(object.key);
    console.log(`Deleted cache: ${object.key}`);
  }
}

// æ¸…ç†æ‰€æœ‰ç¼“å­˜ï¼ˆæ…ç”¨ï¼‰
async function clearAllCache() {
  const list = await env.R2.list({ prefix: 'cache/' });
  
  for (const object of list.objects) {
    await env.R2.delete(object.key);
  }
  
  console.log(`Cleared ${list.objects.length} cached images`);
}
```

### è‡ªåŠ¨æ¸…ç†ç­–ç•¥ï¼ˆå¯é€‰ï¼‰

```javascript
// å¯ä»¥åœ¨ cron ä»»åŠ¡ä¸­å®šæœŸæ¸…ç†æ—§ç¼“å­˜
async function cleanupOldCache(env, maxAgeDays = 90) {
  const cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - maxAgeDays);
  
  const list = await env.R2.list({ prefix: 'cache/' });
  let deletedCount = 0;
  
  for (const object of list.objects) {
    if (object.uploaded < cutoffDate) {
      await env.R2.delete(object.key);
      deletedCount++;
    }
  }
  
  console.log(`Cleaned up ${deletedCount} old cached images`);
}
```

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| **CDN ç¼“å­˜å‘½ä¸­ç‡** | > 95% | å¤§éƒ¨åˆ†è¯·æ±‚ä¸åˆ°è¾¾ Worker |
| **R2 ç¼“å­˜å‘½ä¸­ç‡** | > 90% | åˆ°è¾¾ Worker çš„è¯·æ±‚ä¸­å‘½ä¸­ç¼“å­˜ |
| **Image Resizing è°ƒç”¨** | é¦–æ¬¡è¯·æ±‚ | æ¯ä¸ªå‚æ•°ç»„åˆåªè°ƒç”¨ä¸€æ¬¡ |
| **å¹³å‡å“åº”æ—¶é—´** | < 50ms | CDN ç¼“å­˜å‘½ä¸­ |

### æ—¥å¿—ç¤ºä¾‹

```
âœ… æ­£å¸¸æƒ…å†µï¼ˆé«˜ç¼“å­˜å‘½ä¸­ç‡ï¼‰
[ImageTransform] Request: images/photo-original.jpg, cache key: cache/images/photo-original-fwebp-w800.webp
[ImageTransform] âœ… Cache HIT from R2: cache/images/photo-original-fwebp-w800.webp

ğŸ”„ é¦–æ¬¡è¯·æ±‚ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰
[ImageTransform] Request: images/photo-original.jpg, cache key: cache/images/photo-original-fwebp-w800.webp
[ImageTransform] Cache MISS, transforming: cache/images/photo-original-fwebp-w800.webp
[ImageTransform] âœ… Transform completed, response sent
[ImageTransform] âœ… Cached to R2: cache/images/photo-original-fwebp-w800.webp (245.32KB)
```

## ğŸ’¡ æœ€ä½³å®è·µæ€»ç»“

1. **âœ… ä¼˜å…ˆä½¿ç”¨é¢„å¤„ç†å›¾ç‰‡**
   - ä¸Šä¼ æ—¶ç”Ÿæˆçš„ `-display.webp`
   - æœ€å¿«ï¼Œé›¶è½¬æ¢è´¹ç”¨

2. **âœ… åŠ¨æ€è½¬æ¢ç”¨äºç‰¹æ®Šåœºæ™¯**
   - å“åº”å¼å›¾ç‰‡ï¼ˆå¤šå°ºå¯¸ï¼‰
   - ç”¨æˆ·è‡ªå®šä¹‰å°ºå¯¸
   - é¦–æ¬¡è¯·æ±‚åæ°¸ä¹…ç¼“å­˜

3. **âœ… ä½¿ç”¨é¢„å®šä¹‰å°ºå¯¸**
   - æé«˜ç¼“å­˜å‘½ä¸­ç‡
   - å‡å°‘å­˜å‚¨ç©ºé—´

4. **âœ… å……åˆ†åˆ©ç”¨ CDN**
   - è®¾ç½®é•¿ç¼“å­˜æ—¶é—´ï¼ˆ1 å¹´ï¼‰
   - ä½¿ç”¨ `immutable` æ ‡è®°

5. **âœ… ç›‘æ§å’Œä¼˜åŒ–**
   - å®šæœŸæ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
   - æ¸…ç†ä¸å¸¸ç”¨çš„ç¼“å­˜

## ğŸ¯ æˆæœ¬ä¼˜åŒ–æ•ˆæœ

### å®é™…æ¡ˆä¾‹

å‡è®¾ç½‘ç«™æœ‰ï¼š
- 1000 å¼ å›¾ç‰‡
- æ¯å¼ å›¾ç‰‡ 3 ç§å°ºå¯¸ï¼ˆ400, 800, 1200ï¼‰
- æ¯æœˆ 100 ä¸‡æ¬¡å›¾ç‰‡è¯·æ±‚

**æ— ç¼“å­˜æ–¹æ¡ˆï¼š**
- Image Resizing è°ƒç”¨ï¼š100 ä¸‡æ¬¡
- è´¹ç”¨ï¼š**$1,000 - $5,000/æœˆ** ğŸ’¸

**ä¸‰çº§ç¼“å­˜æ–¹æ¡ˆï¼ˆæœ¬æ–¹æ¡ˆï¼‰ï¼š**
- Image Resizing è°ƒç”¨ï¼š3,000 æ¬¡ï¼ˆä»…é¦–æ¬¡ï¼‰
- R2 è¯»å–ï¼š100 æ¬¡ï¼ˆCDN æœªå‘½ä¸­æ—¶ï¼‰
- CDN å‘½ä¸­ï¼š99.99 ä¸‡æ¬¡ï¼ˆå…è´¹ï¼‰
- è´¹ç”¨ï¼š**$3 - $15/æœˆ** âœ…

**èŠ‚çœï¼š** 99.7% - 99.9%

---

**æœ€åæ›´æ–°ï¼š** 2025-10-25  
**ç‰ˆæœ¬ï¼š** v1.0.0

