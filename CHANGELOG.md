# 更新日志

## [v1.2.8] - 2024-10-15

### 🚀 重大架构升级

#### 并发处理架构 - 彻底解决卡死问题

**核心改进：**

1. **两阶段并发处理**
   - **阶段1：并发重复检测**（全部文件同时）
     - 使用 `Promise.all()` 并发处理所有文件
     - 快速完成：读取 + 哈希 + 数据库查询
     - 重复文件立即标记跳过
     - **不进行任何 AI 分析**（核心优化）
   
   - **阶段2：并发 AI 处理**（每次3张）
     - 只处理非重复文件
     - 3张图片同时进行 AI 分析
     - 组间串行，避免过载
     - 批次间隔 500ms

2. **性能提升**
   - 重复检测速度提升 **10 倍**（全并发）
   - AI 处理速度提升 **3 倍**（3并发）
   - 100 张图片：16 分钟 → **5-6 分钟**
   - 重复文件：秒级跳过（不占用 AI 资源）

3. **彻底解决卡死**
   - 重复检测阶段：快速并发，不会卡死
   - AI 处理阶段：即使单张卡死也不影响其他2张
   - 并发隔离：每个文件独立超时保护
   - 组内互不影响：一个超时，其他继续

### 🎯 效果对比

| 版本 | 架构 | 100张图片 | 重复检测 | 卡死风险 |
|------|------|-----------|----------|----------|
| v1.2.6 | 串行 | 16-20 分钟 | 逐个检测 | 高 ❌ |
| v1.2.7 | 串行+超时 | 16-20 分钟 | 逐个检测 | 中 ⚠️ |
| v1.2.8 | 并发 | **5-6 分钟** | 全并发 | 极低 ✅ |

### 📝 文件修改
- `src/index.js` - 重构为并发架构、两阶段处理

---

## [v1.2.7] - 2024-10-15

### 🐛 重大修复

#### 解决批次处理卡死问题

**问题诊断：**
- 单个操作超时可能导致整个批次卡死
- 缺少总体超时保护机制
- 步骤之间没有有效隔离

**解决方案：**

1. **分步骤处理架构**
   - 将图片处理拆分为7个独立步骤
   - 每个步骤独立超时保护
   - 步骤失败不影响后续图片

2. **多层超时保护**
   ```
   总超时: 120秒 (整个文件)
   ├─ 步骤1: 文件读取 (10秒)
   ├─ 步骤2: 哈希生成 (5秒)
   ├─ 步骤3: 重复检测 (5秒)
   ├─ 步骤4: R2上传 (30秒)
   ├─ 步骤5: 获取尺寸 (5秒)
   ├─ 步骤6: AI分析 (60秒)
   └─ 步骤7: 数据库存储 (10秒)
   ```

3. **详细日志追踪**
   - 每个步骤开始时记录日志
   - 包含批次ID和文件索引
   - 显示处理耗时
   - 便于定位卡死步骤

**效果：**
- ✅ 单张图片超时自动跳过
- ✅ 不会阻塞整个批次
- ✅ 精确定位卡死步骤
- ✅ 大幅降低卡死概率

### 📝 文件修改
- `src/index.js` - 重构处理流程、添加超时保护

---

## [v1.2.6] - 2024-10-15

### ✨ 新功能

#### 批次取消功能
- 进度面板显示"取消"按钮（红色）
- 点击后立即停止后台处理
- 已处理的图片不受影响
- 后台循环检查取消状态，响应迅速

#### 卡死检测与警告
- 自动追踪每个批次的最后活动时间
- 超过2分钟无响应自动标记为疑似卡死
- 黄色背景高亮显示卡死批次
- 显示具体无响应秒数（如"超过 125秒 无响应"）

#### 状态追踪增强
- 记录当前正在处理的文件名
- 实时更新最后活动时间（每次操作）
- 进度面板底部显示当前处理文件
- 便于定位处理卡在哪张图片

### 🐛 问题修复

- 解决批次卡死无法停止的问题
- 解决无法定位卡死原因的问题
- 提供手动取消选项

### 🎯 用户体验

- 批次出现问题可随时取消
- 清晰识别卡死状态
- 了解当前处理进度
- 减少无效等待时间

### 📝 文件修改
- `src/index.js` - 取消API、卡死检测、状态追踪
- `src/admin.js` - 取消按钮、卡死警告UI

---

## [v1.2.5] - 2024-10-15

### ✨ 功能改进

#### 批量上传增强
- **移除数量限制**：不再限制一次上传10张，支持任意数量
- **重复图片智能处理**：
  - 自动检测重复图片（SHA-256哈希）
  - 跳过重复图片，避免重复分析
  - 进度面板显示重复跳过数量（⏭️ 图标）
- **错误处理与重试**：
  - AI 分析失败自动重试 3 次
  - 重试间隔递增（2秒、4秒、6秒）
  - 3次失败后跳过，记录详细错误
- **进度展示优化**：
  - 显示批次总数和已处理数量
  - 分类统计：✅ 成功、⏭️ 重复、❌ 失败、⚙️ 处理中
  - 进度条反映实际处理进度（包含跳过的图片）
  - 颜色区分不同状态

### 🎯 用户体验

- 处理过程更透明，清楚知道每张图片的状态
- 问题定位更清晰，失败原因一目了然
- 减少无效等待，跳过重复和失败
- 批量处理更高效，支持大批量上传

### 📝 文件修改
- `src/index.js` - 删除数量限制、添加重试逻辑、重复统计
- `src/admin.js` - 更新UI提示、优化进度显示

---

## [v1.2.4] - 2024-10-15

### ✨ 新功能

#### 批量上传实时进度监控
- 右上角实时进度监控面板
- 显示所有进行中的批处理任务
- 进度条动态更新（每5秒）
- 显示完成数、失败数、处理中数量
- 显示处理耗时（分:秒）

### 🎯 后端优化

#### 批次状态追踪
- 使用 KV 存储批次状态（1小时TTL）
- 新增 API: `/api/admin/batch-status`
- 实时更新处理进度
- 自动标记完成状态
- 完成后1小时自动清理

### 🎨 用户体验改进

#### 进度监控面板
- 面板可折叠/展开
- 无任务时自动隐藏
- 不干扰正常操作
- 视觉美观，融入界面
- 任务数量徽章显示

### 📝 文件修改
- `src/index.js` - 批次状态管理、进度API
- `src/admin.js` - 进度监控面板、轮询逻辑

---

## [v1.2.3] - 2024-10-15

### ✨ 新功能

#### 批量上传支持拖拽
- 批量上传区域支持拖拽图片
- 拖拽悬停时视觉反馈（变色、缩放）
- 自动过滤非图片文件

### 🎯 用户体验改进

#### 上传进度优化
- 上传成功后可关闭对话框，后台继续处理
- 新增"后台处理"按钮，方便快速关闭
- 10秒后自动关闭对话框
- 关闭后右上角显示通知提示
- 更详细的处理进度信息

#### 页面保护
- 上传中关闭页面时弹出确认提示
- 点击模态框外部时二次确认
- 防止意外中断上传

### 📝 文件修改
- `src/admin.js` - 批量上传拖拽功能、进度显示优化、页面保护

---

## [v1.2.2] - 2024-10-15

### 🐛 Bug 修复

#### 管理后台数据清理功能修复
- 修复数据清理功能无法清除数据的问题
- 将 cleanup API 从 secret 验证改为 Token 认证
- 与管理后台的认证体系统一

### ✨ 功能改进
- 新增单独的"清空数据库"选项
- 优化批量删除逻辑（R2 每次最多1000个对象）
- 改进错误处理和结果显示
- 清理后自动刷新统计数据和图片列表

### 📝 文件修改
- `src/index.js` - `handleCleanup` 函数重构
- `src/admin.js` - 前端清理逻辑优化

---

## [v1.2.1] - 2024-10-15

### 🔧 优化

#### 1. JSON 数据精简
- JSON 数据仅返回 `description` 和 `tags` 字段
- API `/api/image-json/{slug}` 返回精简数据
- 减少数据传输量，提升响应速度

#### 2. JSON 模块折叠
- JSON Data 模块默认折叠状态
- 点击标题可展开/折叠
- 图标指示当前状态（▶/▼）
- 改善页面简洁度

#### 3. AI 分析优化
- 图片描述长度：100 字符 → 50 字符
- 更简洁的描述提示词
- max_tokens：100 → 50

#### 4. 压缩优化
- 压缩图片长边：500px → 256px
- 减少 AI 处理时间
- 降低传输带宽

### 📝 文件修改
- `src/index.js` - 新增 `handleGetImageJson` 函数
- `src/analyzer.js` - 优化描述提示词和 token 数
- `src/html-builder.js` - JSON 折叠功能、压缩尺寸调整

---

## [v1.2.0] - 2024-10-15

### ✨ 新功能

#### 1. 防重复上传
- 上传图片时自动检测哈希值
- 如果图片已存在，返回重复提示并跳转到已有图片
- 避免浪费存储空间和 AI 算力

#### 2. 防滥用机制
- **速率限制**：每个 IP 每小时最多 10 次上传
- **机器人检测**：识别并记录可疑的 User-Agent
- **行为分析**：检测缺少 Referer 等异常行为
- **友好提示**：达到限制时显示剩余时间

#### 3. 域名更新
- 统一使用 imageaigo.cc 域名
- 更新所有相关链接和文档

### 🔒 安全增强
- IP 基础的速率限制（使用 KV 存储）
- 可疑行为日志记录
- 返回 429 状态码和 Retry-After 头

### 📝 文件修改
- `src/index.js` - 速率限制、重复检测、可疑行为检测
- `src/html-builder.js` - 前端处理重复图片跳转、速率限制提示
- `README.md` - 更新域名

---

## [v1.1.0] - 2024-10-15

### ✨ 新功能

#### 1. KV 缓存优化
- 图片列表 API 增加 KV 缓存（5分钟）
- 图片详情 API 增加 KV 缓存（10分钟）
- 大幅减少数据库查询，提升响应速度

#### 2. 批量上传功能
- 管理后台新增批量上传入口
- 支持一次上传最多 10 张图片
- 异步后台处理，避免请求超时
- 实时显示上传进度
- 自动去重，跳过已存在的图片

#### 3. 删除操作优化
- 删除图片时自动清理相关 KV 缓存
- 清理包括：图片哈希缓存、图片详情缓存、列表缓存
- 确保数据一致性

#### 4. 图片详情页增强
- 显示完整的 JSON 数据
- 提供 JSON API URL（`/api/image-json/{slug}`）
- 一键复制 JSON 数据
- 一键复制 API URL
- 方便开发者集成使用

### 🔧 重构
- Footer 统一化：创建独立模板，所有页面使用统一 footer
- 文档优化：精简文档，仅保留 README、CHANGELOG、LICENSE

### 📝 文件修改
- 新增：`src/footer-template.js`、`.cursorrules`
- 更新：`src/index.js`、`src/admin.js`、`src/html-builder.js`
- 删除：6 个冗余文档

---

## [v1.0.3] - 2024-10-15

### 重构
- Footer 统一化：创建独立模板，所有页面使用统一 footer
- 文档优化：精简文档，仅保留 README、CHANGELOG、LICENSE

---

## [v1.0.2] - 2024-10-15

### 新功能
- **首页标签可点击**：Level 1 标签跳转到 category 页面，其他跳转到 tag 页面
- **Category 页面点赞**：图片卡片可直接点赞/取消点赞

### 样式优化
- 标签悬停效果（缩放 + 阴影）
- 点赞按钮红色主题，流畅动画

---

## [v1.0.1] - 2024-10-15

### Bug 修复
- **图片尺寸存储问题**：修复存储压缩图尺寸的问题，现在正确存储原始图片尺寸
  - 导出 `getImageDimensions` 函数
  - 从原始图片获取尺寸
  - 用原始尺寸覆盖分析结果

---

## [v1.0.0] - 2024-10-15

### 核心功能

#### AI 图片分析
- 智能描述生成（Llama 3.2 11B Vision）
- 层级化标签系统（主分类、子分类、属性）
- 自动尺寸提取（JPEG/PNG/GIF/WebP）
- 基于哈希的去重

#### 用户界面
- 瀑布流响应式布局
- 全文搜索
- 分类/标签筛选
- 点赞功能

#### 管理后台
- Token 认证系统
- 数据统计面板
- 图片管理（查看、搜索、删除）
- 标签管理
- 系统清理（R2、KV、数据库）

#### 技术特性
- Cloudflare Workers Edge 计算
- D1 数据库
- R2 对象存储
- KV 缓存
- 多级缓存策略
- 防盗链保护
- SEO 优化

---

## 版本说明

- **v1.0.x**: 功能完善和优化阶段
- **v1.0.0**: 初始发布版本

详细更新内容请查看各版本说明。
